<?php

$nc_core = nc_core::get_object();
$netshop = nc_netshop::get_instance();

if (!$netshop->cart->get_item_count()) {

    // корзина пуста! оформление заказа невозможно
    echo "<p class='error'>", NETCAT_MODULE_NETSHOP_ERROR_CART_EMPTY, "</p>\n";

} else if(1 || $current_user['User_ID']){

    /**
     *  Оформление заказа производится:
     *  — на одной странице, если возможные методы доставки и оплаты не зависят от данных,
     *    указываемых пользователем при оформлении заказа;
     *  — на двух страницах, если методы доставки или оплаты зависят от данных,
     *    указываемых пользователем при оформлении заказа, и возможные способы оплаты не
     *    зависят от способов доставки;
     *  — на трёх страницах, если методы оплаты зависят от способов доставки.
     *
     *  1-страничный режим: данные заказа и выбор способа оплаты и выбор способа доставки
     *  2-страничный режим: данные заказа > выбор способа оплаты и выбор способа доставки
     *                 или: данные заказа и выбор способа оплаты > выбор способа доставки
     *  3-страничный режим: данные заказа > выбор способа оплаты > выбор способа доставки
     *
     *  Если включена опция «Показывать страницу подтверждения заказа», то также будет
     *  дополнительно отображена страница подтверждения.
     */

    // Список способов доставки и оплаты на текущем сайте:

    $all_delivery_methods = $netshop->delivery->get_enabled_methods();
    $all_payment_methods = $netshop->payment->get_enabled_methods();

    // объекты, необходимые для дальнейших расчётов для способов доставки и оплаты:
    $order = nc_netshop_order::from_post_data((array)$nc_core->input->fetch_post(), $netshop);
    $context = $netshop->get_condition_context();
    $context->set_order($order);

    // -------------------------------------------------------------------------
    // Некоторые настройки отображения
    // -------------------------------------------------------------------------
    // Для изменения настроек используйте соответствующие пункты в «Настройках
    // отображения компонента» в настройках инфоблока.

    // Загружать данные о стоимости и сроках доставки для способов с
    // автоматизированным расчётом через AJAX (по умолчанию — true):
    $use_ajax_to_load_delivery_estimate =
        isset($cc_settings['delivery_ajax_loading']) ? $cc_settings['delivery_ajax_loading'] : true;

    // Показывать недоступные методы доставки в списке способов доставки:
    $show_unavailable_delivery_methods =
        isset($cc_settings['show_all_delivery_methods']) ? $cc_settings['show_all_delivery_methods'] : false;

    // Показывать недоступные методы оплаты в списке способов оплаты:
    $show_unavailable_payment_methods =
        isset($cc_settings['show_all_payment_methods']) ? $cc_settings['show_all_payment_methods'] : false;

    // Показывать страницу подтверждения (по умолчанию — true):
    $show_confirmation_page =
        isset($cc_settings['show_confirmation_page']) ? $cc_settings['show_confirmation_page'] : true;

    // -------------------------------------------------------------------------
    // Определение количества страниц, которое потребуется для оформления заказа
    // -------------------------------------------------------------------------

    // Сколько страниц будет в оформлении заказа:
    $pages = 1;

    // Страница, на которой пользователя спросят о способах доставки:
    $delivery_page = count($all_delivery_methods) ? 1 : 0;
    // Страница, на которой пользователя спросят о способах оплаты:
    $payment_page = count($all_payment_methods) ? 1 : 0;
    // Страница подтверждения заказа:
    $confirmation_page = 0;

    // Если способы доставки зависят от полей заказа, показывать их на второй странице
    if ($all_delivery_methods->any('depends_on_order_data', true)) {
        $pages = 2;
        $delivery_page = 2;
    }

    // Если способы оплаты зависят от полей заказа, показывать их на второй странице
    if ($all_payment_methods->any('depends_on_order_data', true)) {
        $pages = 2;
        $payment_page = 2;
    }

    // Если способы оплаты зависят от способов доставки, показывать их на отдельной
    // (второй или третьей) странице
    if ($all_payment_methods->any('depends_on_delivery_method', true)) {
        $pages++;
        $payment_page = $delivery_page + 1;
    }

    // Учесть страницу подтверждения заказа:
    if ($show_confirmation_page) {
        $pages++;
        $confirmation_page = $pages;
    }

    // Заголовки страниц
    $page_titles = array(
        1 => NETCAT_MODULE_NETSHOP_CHECKOUT_ORDER_DATA_SECTION,
    );

    if ($payment_page == 2 && $payment_page == $delivery_page) {
        $page_titles[$payment_page] = NETCAT_MODULE_NETSHOP_CHECKOUT_DELIVERY_AND_PAYMENT_METHOD_SECTION;
    } else {
        if ($delivery_page > 1) {
            $page_titles[$delivery_page] = NETCAT_MODULE_NETSHOP_CHECKOUT_DELIVERY_METHOD_SECTION;
        }
        if ($payment_page > 1) {
            $page_titles[$payment_page] = NETCAT_MODULE_NETSHOP_CHECKOUT_PAYMENT_METHOD_SECTION;
        }
    }

    if ($confirmation_page) {
        $page_titles[] = NETCAT_MODULE_NETSHOP_CHECKOUT_CONFIRMATION_SECTION;
    }

    if ($all_payment_methods->any("handler_id", 0, ">")) {
        $page_titles[] = NETCAT_MODULE_NETSHOP_PAYMENT;
    }

    // Текущая страница:
    $current_page = $is_posted = $nc_core->input->fetch_post('current_page');
    if (!$current_page) {
        $current_page = 1;
    }
    $go_to_next_page = $nc_core->input->fetch_post('go_to_next_page');

    // -------------------------------------------------------------------------
    // Сообщения об ошибках в полях формы
    // -------------------------------------------------------------------------

    // В многостраничном режиме — проверить данные заказа на первой странице
    // (обязательные поля, формат полей)
    if ($is_posted && $pages > 1) {
        $posting = 1;
        require $nc_core->ROOT_FOLDER . "message_fields.php"; // nb, not require_once
        $posting = 0;
        // Если возникла ошибка — возврат на первую страницу
        if ($warnText) {
            $current_page = 1;
        }
    }

    // Ошибки в случае, если форма заполнена неправильно, выводятся в блоке «Данные заказа».
    // Если ошибок нет — переходим к следующей странице

    if (!$warnText && $go_to_next_page && $pages > 1) {
        $current_page++;
    }

    // -------------------------------------------------------------------------
    // Общая часть формы (начало)
    // -------------------------------------------------------------------------
    ?>
    <h1>Оформление заказа</h1>
    <form method='post' action='<?= $SUB_FOLDER . $HTTP_ROOT_PATH ?>add.php' id='nc_netshop_add_order_form'>
    <input name='admin_mode' type='hidden' value='<?= $nc_core->admin_mode ?>'/>
    <?= $nc_core->token->get_input() . "\n" ?>
    <input name='catalogue' type='hidden' value='<?= $catalogue ?>'/>
    <input name='cc' type='hidden' value='<?= $cc ?>'/>
    <input name='sub' type='hidden' value='<?= $sub ?>'/>
    <input name='posting' type='hidden' value='0'/>
    <input name='curPos' type='hidden' value='0'/>
    <input name='f_Parent_Message_ID' type='hidden' value='0'/>
    <input name='current_page' type='hidden' value='<?= $current_page ?>'/>


    <!-- Хлебные крошки-->
    <!--div class="tpl-block-breadcrumbs tpl-block-breadcrumbs--steps">
        <div class="tpl-block-breadcrumbs-item">
            <a href="<?= $nc_core->SUB_FOLDER; ?>/"><?= $nc_core->catalogue->get_current('Catalogue_Name'); ?></a>
        </div>
        <div class="tpl-block-breadcrumbs-item">
            <a href="<?= $nc_core->SUB_FOLDER; ?>/cart"><?= NETCAT_MODULE_NETSHOP_CART ?></a>
        </div>
        <?php

        for ($i = 1; $i <= sizeof($page_titles); $i++) {
            echo '<div class="tpl-block-breadcrumbs-item">',
            '<a href="#" class="tpl-state-', ($current_page < $i ? 'disabled' : 'current'), '">',
            $page_titles[$i],
            "</a></div>\n";
        }

        ?>
    </div-->


    <? if ($current_page == 1) { ?>
        
            <h3><?= NETCAT_MODULE_NETSHOP_CHECKOUT_ITEMS_SECTION; ?></h3>
            <?
            // --- Блок «Подтверждение состава заказа» ---
            $items = $netshop->cart->get_items();
            
            $isNeedGoods = 0;
            $isGoodsInCart = 0;
            foreach ($items as $item) {
                if($item['Class_ID'] == 2000) $isGoodsInCart = 1;
                if($item['isNeedGoods']) $isNeedGoods = 1;            
            }
            
            
            $has_discount_column = $items->any('ItemDiscount', 0, '>');

            echo $netshop->cart->get_quantity_notifications(),
            "<div class='cart'><table>\n<tr>\n",
                "<th align='left'>" . NETCAT_MODULE_NETSHOP_ITEM . "</th>\n",
                "<th align='left'>" . NETCAT_MODULE_NETSHOP_ITEM_PRICE . "</th>\n",
                "<th align='left' class='quantity'><span>" . NETCAT_MODULE_NETSHOP_QTY . "</span><span class='mobile'>кол.</span></th>\n",
                "<th align='left'>" . NETCAT_MODULE_NETSHOP_COST . "</th>\n",
            ($has_discount_column ? "<th align='left'>Учтенная скидка</th>\n" : "");

            foreach ($items as $item) {
                echo "<tr>
                <td>
                ".($item['Image']?"<img src='".RESIZER($item['Image'],1000,50)."' style='vertical-align:middle'>":NULL)." ".$item[FullName].($item['Color']?", ".$item['Color']:NULL)."
                ".($item['isNeedGoods'] && !$isGoodsInCart?"
                <div class='goods_alert'>Вместе с этой услугой необходимо заказать предметы для возложения.<br><a href='/catalog/'>Сделать это можно тут</a></div>                
                ":NULL)."
                ".($item['Class_ID'] && !$isNeedGoods?"
                <div class='goods_alert'>Товары можно заказывать только вместе с соответствующей услугой.<br><a href='/care/'>Сделать это можно тут</a></div>                
                ":NULL)."               
                </td>
                <td>".($item['Class_ID'] != 2028 ? $item['ItemPriceF'] : $item['TotalPriceF'])."</td>
                <td>".($item['Class_ID'] != 2028 ? $item['Qty'] : '1')."</td>
                <td style='text-align: left;'>".($item[TotalPriceF])."</td>
                ".($has_discount_column ? "<td align='left' style='text-align: left;'>$item[TotalDiscountF]</td>" : "")."
                </tr>\n";
               
            }

            echo "<tr>",
                "<td colspan='3'>" . NETCAT_MODULE_NETSHOP_SUM . "</td>",
                "<td style='text-align: left;'>" . $netshop->format_price($netshop->cart->get_totals()) . "</td>",
            ($has_discount_column ? "<td style='text-align: left;'>" . $netshop->format_price($netshop->cart->get_discount_sum()) . "</td>" : ""),
            "</tr>\n</table></div>\n<br>";
            ?>
    <? } ?>

    <!--h3><?= $page_titles[$current_page]; ?></h3-->

    <?php
    # если среди заказанных услуг есть возложение, то должны быть и товары
    if( (!$isNeedGoods && !$isGoodsInCart) || ($isGoodsInCart && $isNeedGoods)){

    // Количество блоков (адрес / доставка / оплата), уже показанных на текущей странице:
    $blocks_shown = 0;

    // -------------------------------------------------------------------------
    // Данные заказа
    // -------------------------------------------------------------------------
    if ($current_page == 1) {
        // Подготавливаем данные пользователя:
        $user = $AUTH_USER_ID ? nc_Core::get_object()->user->get_by_id($AUTH_USER_ID) : null;

        $contact_name = null;
        if (!isset($f_ContactName) && isset($user['ForumName'])) {
            $contact_name = $user['ForumName'];
        }

        $contact_email = null;
        if (!isset($f_Email) && isset($user['Email'])) {
            $contact_email = $user['Email'];
        }

        // Сделать выбранным по умолчанию город, в котором расположен магазин
        $selected_city = null;
        if (!isset($f_City)) {
            $selected_city = $netshop->get_setting('City');
        }

        $sign_up = $nc_core->input->fetch_post('f_SignUp');

        // Сообщение об ошибке (если есть)
        if ($warnText) {
            echo "<p class='error'>$warnText</p>\n";
        }
        
        
       
        // Поля формы:
        ?>
        <br><h3>Контактные данные</h3>
        <p>
        <input type="text" name="f_Email" value="<?=$current_user['Email']?>" placeholder='Эл. почта'>
        <input type="text" name="f_ContactName" value="<?=$current_user['Name']?>" placeholder='Ваше имя'>
        <input type="text" name="f_Phone" value="<?=$current_user['Phone']?>" placeholder='Телефон'>
        </p>
        
        <br><h3>Данные о захоронении</h3>
            <?
            if(isset($_COOKIE['burial'])){
                $aBurial = $db->get_row("
                    SELECT M.Message_ID AS ID, M.Name, B.Burial_Name AS Burial
                    FROM Message2020 AS M
                    LEFT JOIN Classificator_Burial AS B ON M.Burial = B.Burial_ID
                    WHERE M.Message_ID = ".(int)$_COOKIE['burial']
                ,ARRAY_A);
                if($aBurial){
            ?>
                <p>Захоронение: <?=$aBurial['Name'].($aBurial['Burial']?" (".$aBurial['Burial'].")":NULL)?></p>
                <input type='hidden' name="f_BurialID" value="<?=$aBurial['ID']?>">
                <input type='hidden' name="f_BurialName" value="<?=$aBurial['Name'].($aBurial['Burial']?" (".$aBurial['Burial'].")":NULL)?>">
                <p>Желательная дата возложения и уборки: <?=nc_string_field('Dt','class="datepicker" style="width:150px" readonly',$classID,0)?></p>
            <?
                }
            }
            ?>
        

            
       <?

        // В случае возврата со страницы подтверждения нужно сохранить выбранные
        // способы доставки и оплаты
        foreach (array('f_DeliveryMethod', 'f_PaymentMethod') as $var) {
            if (isset($$var)) {
                echo "<input type='hidden' name='" . $$var . "' value='" . htmlspecialchars($$var, ENT_QUOTES) . "' />\n";
            }
        }

        $blocks_shown++;
    } else {

        // Это уже не первая страница; необходимо сохранить введённые значения
        // в hidden-полях формы:
        foreach ((array)$nc_core->input->fetch_post() as $key => $value) {
            if (strpos($key, "f_") === 0) {
                echo "<input type='hidden' name='" . htmlspecialchars($key, ENT_QUOTES) . "' value='" .
                    htmlspecialchars($value, ENT_QUOTES) . "' />\n";
            }
        }

    } // конец блока «Данные заказа»

    // -------------------------------------------------------------------------
    // Выбор способа доставки
    // -------------------------------------------------------------------------

    if ($delivery_page == $current_page) {

    if ($blocks_shown || $delivery_page == $payment_page) {
    if ($current_page == 1) {
        ?>
        <?php
    }
        ?>
        <!--h3></h3-->
    <?php
    }

    $available_delivery_methods = $all_delivery_methods->matching($context);
    $methods_to_show = $show_unavailable_delivery_methods
        ? $all_delivery_methods
        : $available_delivery_methods;

    $num_methods_to_show = count($methods_to_show);

    if (!count($available_delivery_methods)) {
        echo "<p class='error'>" . NETCAT_MODULE_NETSHOP_CHECKOUT_NO_AVAILABLE_DELIVERY_METHODS . "</p>\n";
    }

    $is_first = true; // флаг для пред-выбора первого элемента

    $method_ids_to_load_with_ajax = array();

    $i = 0;
    
    foreach ($methods_to_show as $method) {
    if ($i % 3 == 0) {
    ?>

    <? } ?>
            <?

            /** @var nc_netshop_delivery_method $method */
            $is_available = !$show_unavailable_delivery_methods || $method->evaluate_conditions($context);

            $method_id = $method->get_id();
            $radio_id = "nc_netshop_dm_" . $method_id . "_name";

            // --- Описание способа доставки ---
            $method_description = $method->get('description');
            $delivery_method_price = $method->get('extra_charge_absolute');

            ?>
            
                <?
                // --- Название способа доставки ---
                if ($num_methods_to_show > 1) {
                    // Если способов доставки более одного — нужны радио-кнопки

                    // Решаем, должен ли текущий пункт быть выбранным:
                    if ($is_available) {
                        // checked, если уже был указан метод доставки (возврат со страницы
                        // подтверждения), иначе — если это первый метод в списке:
                        $is_checked = isset($f_DeliveryMethod) ? $f_DeliveryMethod == $method_id : $is_first;
                    } else {
                        // недоступные методы никогда не являются выбранными
                        $is_checked = false;
                    }

                    // Выводим блок для текущего способа доставки:
                    echo "<input type='radio' name='f_DeliveryMethod' value='$method_id' id='$radio_id' " .
                        (!$is_available ? " disabled" : "") .
                        ($is_checked ? " checked" : "") . "/> ";
                } else {
                    // Если выбора нет:
                    if ($is_available) {
                        echo "<input type='hidden' name='f_DeliveryMethod' value='$method_id'/>";
                    }
                } ?>
                <br><h3><?= $method->get('name'); ?></h3>
                <?= $method_description; ?>
                <p><span>Стоимость: <?=$delivery_method_price?> руб.</span></p> 

            <?
            // можно переходить к следующему методу доставки, если он есть
            if ($is_available) {
                $is_first = false;
            }
            ?>

        <?
    if ($i % 3 == 2 || $i == count($methods_to_show) - 1) {
        ?>

    <?
    }

    $i++;
    }

        $blocks_shown++;
    } // конец блока «Выбор способа доставки»
?>



<?
    // -------------------------------------------------------------------------
    // Выбор способа оплаты
    // -------------------------------------------------------------------------

    if ($payment_page == $current_page) {

        if ($blocks_shown) {
            ?>

            <br><h3>
                <?= NETCAT_MODULE_NETSHOP_CHECKOUT_PAYMENT_METHOD_SECTION ?>
            </h3>
        <?php
        }

        $available_payment_methods = $all_payment_methods->matching($context);
        $methods_to_show = $show_unavailable_payment_methods
            ? $all_payment_methods
            : $available_payment_methods;

        $num_methods_to_show = count($methods_to_show);

        if (!count($available_payment_methods)) {
            echo "<p class='tpl-block-errortext'>" . NETCAT_MODULE_NETSHOP_CHECKOUT_NO_AVAILABLE_PAYMENT_METHODS . "</p>\n";
        }

        // Если ранее был указан способ оплаты (возврат со страницы подтверждения
        // заказа), проверим, доступен ли он до сих пор (мог измениться способ
        // доставки):
        $previously_selected_method_is_available = isset($f_PaymentMethod)
            ? $available_payment_methods->any('id', $f_PaymentMethod)
            : false;

        $is_first = true; // флаг для пред-выбора первого элемента

        $i = 0;
        foreach ($methods_to_show as $method) {
            if ($i % 3 == 0) {
                ?>
                
            <? } ?>
            <div style='margin-bottom:10px'>
                <?
                /** @var nc_netshop_payment_method $method */
                $is_available = $method->evaluate_conditions($context);

                $method_id = $method->get_id();
                $radio_id = "nc_netshop_pm_" . $method_id . "_name";

                ?>
                <label for="<?= $radio_id; ?>" class="tpl-block-ichlabel">
                    <?
                    // --- Название способа оплаты ---
                    if ($num_methods_to_show > 1) {
                        // Если способов оплаты более одного — нужны радио-кнопки

                        // Решаем, должен ли текущий пункт быть выбранным:
                        if ($is_available) {
                            // checked, если уже был указан метод оплаты (возврат со страницы
                            // подтверждения), иначе — если это первый метод в списке:
                            $is_checked = isset($f_PaymentMethod) && $previously_selected_method_is_available
                                ? $f_PaymentMethod == $method_id
                                : $is_first;
                        } else {
                            // недоступные методы никогда не являются выбранными
                            $is_checked = false;
                        }

                        // Выводим блок с названием текущего способа оплаты:

                        echo "<input type='radio' name='f_PaymentMethod' value='$method_id' id='$radio_id' " .
                            (!$is_available ? " disabled" : "") .
                            ($is_checked ? " checked" : "") . "/> ";
                    } else {
                        // Если выбора нет:
                        if ($is_available) {
                            echo "<input type='hidden' name='f_PaymentMethod' value='$method_id' />";
                        }
                    }
                    ?>
                    <?= $method->get('name'); ?>
                    <div class="tpl-block-ichlabel-desc">
                        <?= $method->get('description'); ?>
                        <?
                        // --- Наценка за способ оплаты ---
                        if ($method->evaluate_conditions($context)) {
                            $extra_cost = $method->get_extra_cost($order);
                            if ($extra_cost) {
                                echo "<div>",
                                "<span>",
                                    // "Дополнительный сбор: "
                                NETCAT_MODULE_NETSHOP_CHECKOUT_PAYMENT_EXTRA_CHARGE,
                                "</span> ",
                                "<span>", $netshop->format_price($extra_cost), "</span>",
                                "</div>\n";
                            }
                        }
                        ?>
                    </div>
                </label>
                <?

                if ($is_available) {
                    $is_first = false;
                }
                ?>
            </div>
            <?
            if ($i % 3 == 2 || $i == count($methods_to_show) - 1) {
                ?>
                
            <?
            }

            $i++;

        } // foreach $methods_to_show

        $blocks_shown++;
    } // конец блока «Выбор способа оплаты»
?>
<br><h3>Примечание к заказу</h3>
<?= nc_text_field("Comments", "size='50' class='tpl-block-itext tpl-block-itext--style_dull'", $classID); ?>
<?
    // -------------------------------------------------------------------------
    // Подтверждение заказа
    // -------------------------------------------------------------------------

    if ($confirmation_page == $current_page) {
        // Итоговая сумма к оплате
        $total_sum = $netshop->cart->get_totals();

        echo "<div class='tpl-block-section'>\n",
            // "Подтверждение заказа"
        "<h3>", NETCAT_MODULE_NETSHOP_CHECKOUT_CONFIRMATION_SECTION, "</h3>\n",
            // "Пожалуйста, проверьте правильность указанных данных."
        "<p>", NETCAT_MODULE_NETSHOP_CHECKOUT_PLEASE_REVIEW_ORDER, "</p>";

        // --- Блок «Подтверждение контактных данных и адреса» ---
        echo "<div class='tpl-block-order-confirmation'>\n",
            // "Контактные данные и адрес доставки"
        "<h4>", NETCAT_MODULE_NETSHOP_CHECKOUT_ORDER_DATA_SECTION, "</h4>\n";

        $order_component = new nc_component($classID);
        foreach ($order->to_array() as $field_name => $value) {
            // Способы оплаты и доставки показываются в отдельном блоке:
            if ($field_name == 'DeliveryMethod' || $field_name == 'PaymentMethod') {
                continue;
            }

            $field = $order_component->get_field($field_name);

            // Не выводить поля, не являющиеся полем компоненты или «служебные» (напр., "user_hash")
            if (!$field || !$field['description']) {
                continue;
            }

            // Не выводить поля без значений:
            if (!strlen($value)) {
                continue;
            }

            // форматирование / подготовка значения в зависимости от типа поля:
            switch ($field['type']) {
                case NC_FIELDTYPE_BOOLEAN:
                    $value = $value ? NETCAT_MODULE_NETSHOP_CHECKOUT_BOOLEAN_FIELD_YES
                        : NETCAT_MODULE_NETSHOP_CHECKOUT_BOOLEAN_FIELD_NO;
                    break;

                case NC_FIELDTYPE_TEXT:
                    $value = "<blockquote>" . nl2br(htmlspecialchars($value)) . "</blockquote>\n";
                    break;

                case NC_FIELDTYPE_SELECT:
                case NC_FIELDTYPE_MULTISELECT:
                    $values = explode(",", $value);
                    $value = "";
                    foreach ($values as $id) {
                        $value .= ($value ? ', ' : '') . nc_get_list_item_name($field['table'], $id);
                    }
                    break;

                case NC_FIELDTYPE_DATETIME:
                    $value = date(NETCAT_MODULE_NETSHOP_DATETIME_FORMAT, strtotime($value));
                    $value = preg_replace('/\s+(?:00:)00:00$/', '', $value);
                    break;
            }

            // Строка со значением поля:
            echo "<div class='tpl-field'>\n",
            "<span class='tpl-caption'>$field[description]:</span> ",
            "<span class='tpl-value'>$value</span>\n",
            "</div>\n";

        } // foreach order field

        // Кнопка «Изменить» [введённые данные]
        ?>
        <a class="tpl-block-ibtn tpl-block-ibtn--theme_blue" href="#">
            <?= NETCAT_MODULE_NETSHOP_CHECKOUT_CHANGE_BUTTON; ?>
            <button type="submit" class="tpl-block-ibtn-submit" name="current_page" value="1"></button>
        </a>
        <?

        echo "</div>\n"; // конец блока «Подтверждение контактных данных и адреса»

        // --- Блок «Подтверждение состава заказа» ---
        $items = $netshop->cart->get_items();
        $has_discount_column = $items->any('ItemDiscount', 0, '>');

        echo "<div class='tpl-block-netshop-order-confirm-items'>\n",
            // "Состав заказа"
        "<h4>", NETCAT_MODULE_NETSHOP_CHECKOUT_ITEMS_SECTION, "</h4>\n",
        $netshop->cart->get_quantity_notifications(),
        "<table class='tpl-block-list'>\n<tr>\n",
            "<th class='tpl-field-name' align='left'>" . NETCAT_MODULE_NETSHOP_ITEM . "</th>\n",
            "<th class='tpl-field-price' align='left'>" . NETCAT_MODULE_NETSHOP_ITEM_PRICE . "</th>\n",
            "<th class='tpl-field-qty' align='left'>" . NETCAT_MODULE_NETSHOP_QTY . "</th>\n",
            "<th class='tpl-field-totals' align='left'>" . NETCAT_MODULE_NETSHOP_COST . "</th>\n",
        ($has_discount_column ? "<th class='tpl-field-discount' align='left'>" . NETCAT_MODULE_NETSHOP_DISCOUNT . "</th>\n" : "");

        foreach ($items as $item) {
            echo "<tr>",
            "<td class='tpl-field-name'><a href='$item[URL]'>$item[FullName]</a></td>",
            "<td class='tpl-field-price'>$item[ItemPriceF]</td>",
            "<td class='tpl-field-qty'>$item[Qty]</td>",
            "<td class='tpl-field-totals' style='text-align: left;'>$item[TotalPriceF]</td>",
            ($has_discount_column ? "<td align='left' style='text-align: left;'>$item[TotalDiscountF]</td>" : ""),
            "</tr>\n";
        }

        echo "<tr class='tpl-block-netshop-cart-totals'>",
            "<td colspan='3' class='tpl-caption'>" . NETCAT_MODULE_NETSHOP_SUM . "</td>",
            "<td class='tpl-field-totals' style='text-align: left;'>" . $netshop->format_price($netshop->cart->get_totals()) . "</td>",
        ($has_discount_column ? "<td class='tpl-field-discount'  style='text-align: left;'>" . $netshop->format_price($netshop->cart->get_discount_sum()) . "</td>" : ""),
        "</tr>\n</table>\n<br>";

        echo "</div>\n";

        // --- Блок «Подтверждение способа доставки» ---
        if (isset($f_DeliveryMethod)) {
            echo "<div class='tpl-block-delivery-confirmation'>\n",
                // "Доставка"
            "<h4>", NETCAT_MODULE_NETSHOP_CHECKOUT_DELIVERY_METHOD_SECTION, "</h4>\n";

            $method = $netshop->delivery->get_method_if_enabled($f_DeliveryMethod, $context);
            if (!$method) {
                echo "<p class='tpl-block-error'>",
                NETCAT_MODULE_NETSHOP_CHECKOUT_DELIVERY_INCORRECT_METHOD,
                "</p>\n";
            } else {
                echo "<div class='tpl-field-delivery'>\n",
                "<span class='tpl-caption'>",
                    // "Способ доставки: "
                NETCAT_MODULE_NETSHOP_CHECKOUT_SELECTED_DELIVERY_METHOD,
                "</span> ",
                    // (Название способа доставки)
                "<span class='tpl-value'>", $method->get('name'), "</span>\n",
                "</div>\n";

                /** @var nc_netshop_delivery_estimate $estimate */
                $estimate = $method->get_estimate($order);
                if ($estimate->has_error()) {
                    echo "<p class='tpl-block-error'>",
                        // "Не удалось вычислить стоимость и сроки доставки"
                    NETCAT_MODULE_NETSHOP_CHECKOUT_DELIVERY_ESTIMATE_ERROR,
                    ': ',
                    $estimate->get('error'),
                    "</p>\n";
                } else {
                    $total_sum += $estimate->get('price');

                    // Стоимость доставки
                    echo "<div class='tpl-field-delivery-cost'>\n",
                    "<span class='tpl-caption'>",
                        // "Стоимость: "
                    NETCAT_MODULE_NETSHOP_CHECKOUT_DELIVERY_ESTIMATE_PRICE,
                    "</span> ",
                    "<span class='tpl-value'>", $estimate->get_formatted_price_and_discount(), "</span>\n",
                    "</div>\n";

                    // Даты доставки
                    if ($estimate->get('min_days') != null) {
                        echo "<div class='tpl-field-estimate'>\n",
                        "<span class='tpl-caption'>",
                            // "Ожидаемая дата доставки:" / "Ожидаемые даты доставки:"
                            ($estimate->has_dates_interval()
                                ? NETCAT_MODULE_NETSHOP_CHECKOUT_DELIVERY_ESTIMATE_DATES
                                : NETCAT_MODULE_NETSHOP_CHECKOUT_DELIVERY_ESTIMATE_DATE) .
                            "</span> " .
                            "<span class='tpl-value'>" . $estimate->get_dates_string() . "</span>\n",
                        "</div>\n";
                    }
                }
            }

            // Кнопка «Изменить» [способ доставки]
            if (count($all_delivery_methods->matching($context)) > 1) {
                ?>
                <a class="tpl-block-ibtn tpl-block-ibtn--theme_blue" href="#">
                    <?= NETCAT_MODULE_NETSHOP_CHECKOUT_CHANGE_BUTTON; ?>
                    <button type="submit" class="tpl-block-ibtn-submit" name="current_page" value="<?= $delivery_page; ?>"></button>
                </a>
            <?
            }

            echo "</div>\n";
        }

        // --- Блок «Подтверждение способа оплаты» ---
        if (isset($f_PaymentMethod)) {
            echo "<div class='tpl-block-payment-confirmation'>\n",
                // "Способ оплаты"
            "<h4>", NETCAT_MODULE_NETSHOP_CHECKOUT_PAYMENT_METHOD_SECTION, "</h4>\n";

            $method = $netshop->payment->get_method_if_enabled($f_PaymentMethod, $context);
            if (!$method) {
                echo "<p class='tpl-block-error'>",
                NETCAT_MODULE_NETSHOP_CHECKOUT_PAYMENT_INCORRECT_METHOD,
                "</p>\n";
            } else {
                echo "<div class='tpl-field-payment'>\n",
                "<span class='tpl-caption'>",
                    // "Способ оплаты: "
                NETCAT_MODULE_NETSHOP_CHECKOUT_SELECTED_PAYMENT_METHOD,
                "</span> ",
                    // (Название способа оплаты)
                "<span class='tpl-value'>", $method->get('name'), "</span>\n",
                "</div>\n";

                $extra_cost = $method->get_extra_cost($order);
                if ($extra_cost) {
                    $total_sum += $extra_cost;

                    echo "<div class='tpl-field-payment-cost'>\n",
                    "<span class='tpl-caption'>",
                        // "Дополнительный сбор: "
                    NETCAT_MODULE_NETSHOP_CHECKOUT_PAYMENT_EXTRA_CHARGE,
                    "</span> ",
                    "<span class='tpl-value'>", $netshop->format_price($extra_cost), "</span>\n",
                    "</div>\n";
                }
            }

            // Кнопка «Изменить» [способ оплаты]
            if (count($all_payment_methods->matching($context)) > 1) {
                ?>
                <a class="tpl-block-ibtn tpl-block-ibtn--theme_blue" href="#">
                    <?= NETCAT_MODULE_NETSHOP_CHECKOUT_CHANGE_BUTTON; ?>
                    <button type="submit" class="tpl-block-ibtn-submit" name="current_page" value="<?= $payment_page; ?>"></button>
                </a>
            <?
            }

            echo "</div>\n";
        }

        // --- Итоговые суммы ---
        echo "<div class='tpl-block-totals-confirmation'>\n",
            // "Контактные данные и адрес доставки"
        "<h4>", NETCAT_MODULE_NETSHOP_CHECKOUT_TOTALS_SECTION, "</h4>\n",

        "<div class='tpl-field-items-totals'>\n",
        "<span class='tpl-caption'>",
            // "Стоимость товаров: "
        NETCAT_MODULE_NETSHOP_CHECKOUT_CART_TOTALS,
        "</span> ",
            // (Общая сумма)
        "<span class='tpl-value'>", $netshop->format_price($netshop->cart->get_totals()), "</span>\n",
        "</div>\n",

        "<div class='tpl-field-totals'>\n",
        "<span class='tpl-caption'>",
            // "Общая сумма к оплате: "
        NETCAT_MODULE_NETSHOP_CHECKOUT_ORDER_TOTALS,
        "</span> ",
            // (Общая сумма)
        "<span class='tpl-value'>", $netshop->format_price($total_sum), "</span>\n",
        "</div>\n",

        "</div>\n";

        // --- Конец секции ---
        echo "</div>\n";
    }

    // -------------------------------------------------------------------------
    // Общая завершающая часть формы
    // -------------------------------------------------------------------------

    ?>
    <br><br>
    <h3>ИТОГО К ОПЛАТЕ</h3>
    <p><b><?=($netshop->cart->get_totals() + $delivery_method_price)?> руб.</b></p>
    
    <div style='margin-top:20px'>

            <button type="submit" name="posting" value="1">Оформить заказ</button>

    </div>
    
    <?
        }
        #end if( !$isNeedGoods || ($isGoodsInCart && $isNeedGoods) ){
    ?>


    </form>
<? }else{ ?>
<p>Для оформления заказа необходимо авторизоваться. Если вы еще не зарегистрированы на сайте, то можете <a href='/registratsiya/?order=1'>зарегистрироваться прямо сейчас</a>. Это займет совсем немного времени.</p>
<hr>

<?=$nc_auth->auth_form()?>

<? } ?>